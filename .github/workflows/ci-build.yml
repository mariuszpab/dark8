name: CI Build & Deploy

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    name: Build images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    env:
      STUDIO_IMAGE: ghcr.io/${{ github.repository_owner }}/dark8-studio:${{ github.sha }}
      AGENT_IMAGE: ghcr.io/${{ github.repository_owner }}/dark8-agent:${{ github.sha }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build studio image (local)
        uses: docker/build-push-action@v4
        with:
          context: .
          file: studio/docker/Dockerfile
          tags: ${{ env.STUDIO_IMAGE }}
          push: false

      - name: Build agent image (local)
        uses: docker/build-push-action@v4
        with:
          context: .
          file: agent_local/Dockerfile
          tags: ${{ env.AGENT_IMAGE }}
          push: false

      - name: Login to GHCR
        if: secrets.GHCR_TOKEN != ''
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Push images to GHCR
        if: secrets.GHCR_TOKEN != ''
        uses: docker/build-push-action@v4
        with:
          context: .
          file: studio/docker/Dockerfile
          tags: ${{ env.STUDIO_IMAGE }}
          push: true

      - name: Push agent to GHCR
        if: secrets.GHCR_TOKEN != ''
        uses: docker/build-push-action@v4
        with:
          context: .
          file: agent_local/Dockerfile
          tags: ${{ env.AGENT_IMAGE }}
          push: true

      - name: Save image names
        id: images
        run: |
          echo "studio=${{ env.STUDIO_IMAGE }}" >> $GITHUB_OUTPUT
          echo "agent=${{ env.AGENT_IMAGE }}" >> $GITHUB_OUTPUT

  helm-lint:
    name: Helm lint charts
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Helm
        uses: azure/setup-helm@v3

      - name: Helm lint studio
        run: |
          helm lint k8s/helm/studio

      - name: Helm lint agent
        run: |
          helm lint k8s/helm/agent

  smoke-test:
    name: Smoke test built images
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Load studio image (already built locally)
        run: |
          echo "Using image ${{ needs.build.outputs.studio }}"
        # images are available locally when built with build-push-action with push:false

      - name: Run agent container
        run: |
          docker run -d --name dark8-agent-test -p 18000:8000 ${{ needs.build.outputs.agent }} || docker run -d --name dark8-agent-test -p 18000:8000 ghcr.io/${{ github.repository_owner }}/dark8-agent:latest

      - name: Run studio container
        run: |
          docker run -d --name dark8-studio-test -p 18080:80 ${{ needs.build.outputs.studio }} || docker run -d --name dark8-studio-test -p 18080:80 ghcr.io/${{ github.repository_owner }}/dark8-studio:latest

      - name: Wait for services
        run: |
          for i in {1..20}; do
            sleep 1
            curl -sS http://127.0.0.1:18000/fs/list >/dev/null 2>&1 && break || true
          done

      - name: Test agent FS endpoint
        run: |
          curl -sS http://127.0.0.1:18000/fs/list | jq -C . || (docker logs dark8-agent-test && exit 1)

      - name: Test studio UI
        run: |
          curl -sS http://127.0.0.1:18080/monaco.html | grep -q 'DARK8 Monaco Editor' || (docker logs dark8-studio-test && exit 1)

      - name: Cleanup containers
        if: always()
        run: |
          docker rm -f dark8-agent-test dark8-studio-test || true

  helm-deploy:
    name: Helm deploy (optional)
    runs-on: ubuntu-latest
    needs: build
    if: secrets.KUBE_CONFIG != ''
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Kubeconfig
        run: |
          echo "$KUBE_CONFIG" | base64 -d > kubeconfig
          export KUBECONFIG=$PWD/kubeconfig
        env:
          KUBE_CONFIG: ${{ secrets.KUBE_CONFIG }}

      - name: Install Helm
        uses: azure/setup-helm@v3

      - name: Helm upgrade/install studio and agent
        run: |
          helm upgrade --install dark8-studio k8s/helm/studio \
            --set image.repository=ghcr.io/${{ github.repository_owner }}/dark8-studio \
            --set image.tag=${{ github.sha }}
          helm upgrade --install dark8-agent k8s/helm/agent \
            --set image.repository=ghcr.io/${{ github.repository_owner }}/dark8-agent \
            --set image.tag=${{ github.sha }}

      - name: Wait for deployments
        run: |
          kubectl rollout status deployment/dark8-agent-{{ github.run_id }} --namespace default --timeout=120s || kubectl rollout status deployment/dark8-agent --namespace default --timeout=120s
          kubectl rollout status deployment/dark8-studio-{{ github.run_id }} --namespace default --timeout=120s || kubectl rollout status deployment/dark8-studio --namespace default --timeout=120s

      - name: Port-forward and smoke test
        run: |
          # Port-forward agent service
          kubectl port-forward svc/dark8-agent 18000:8000 >/dev/null 2>&1 &
          PF1=$!
          kubectl port-forward svc/dark8-studio 18080:80 >/dev/null 2>&1 &
          PF2=$!
          sleep 3
          set -e
          echo "Testing agent /fs/list"
          for i in {1..20}; do
            status=$(curl -sS -o /dev/null -w "%{http_code}" http://127.0.0.1:18000/fs/list || echo "000")
            echo "attempt=$i agent status=$status"
            if [ "$status" = "200" ]; then break; fi
            sleep 2
          done
          echo "Testing studio UI"
          curl -sS http://127.0.0.1:18080/monaco.html | grep -q 'DARK8 Monaco Editor'
          kill $PF1 $PF2 || true
name: CI - Build and Publish

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Restore wheelhouse artifact (if available)
        uses: actions/download-artifact@v4
        with:
          name: wheelhouse-artifact
          path: wheelhouse
        continue-on-error: true

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/dark8:latest
            ghcr.io/${{ github.repository_owner }}/dark8:${{ github.sha }}
          platforms: linux/amd64,linux/arm64

      - name: Upload artifacts (optional)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: |
            phase4_docker_build_log.txt

  smoke-test:
    name: Smoke test (run container + check /metrics)
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Pull image
        run: |
          docker pull ghcr.io/${{ github.repository_owner }}/dark8:latest

      - name: Run container
        run: |
          docker run -d --name smoke_dark8 -p 9100:8080 ghcr.io/${{ github.repository_owner }}/dark8:latest || true

      - name: Wait for /metrics
        run: |
          set -e
          for i in {1..30}; do
            status=$(curl -sS -o /dev/null -w "%{http_code}" http://localhost:9100/metrics || echo "000")
            echo "attempt=$i status=$status"
            if [ "$status" = "200" ]; then echo "metrics OK"; exit 0; fi
            sleep 2
          done
          echo "metrics did not become available"; docker logs smoke_dark8 > smoke_logs.txt || true; exit 1

      - name: Stop container
        if: always()
        run: |
          docker stop smoke_dark8 || true

      - name: Upload smoke logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-logs
          path: |
            smoke_logs.txt

  build-ml-image:
    name: Build and push ML image (heavy deps)
    runs-on: ubuntu-latest
    needs: build-and-push
    permissions:
      contents: read
      packages: write
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python (for building wheels)
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install pip build deps
        run: |
          python -m pip install --upgrade pip setuptools wheel

      - name: Build wheelhouse
        run: |
          mkdir -p wheelhouse
          if [ -f requirements.txt ]; then
            pip wheel -r requirements.txt -w wheelhouse || true
          else
            echo "requirements.txt not found"
          fi

      - name: Cache wheelhouse
        uses: actions/cache@v4
        with:
          path: wheelhouse
          key: wheelhouse-${{ runner.os }}-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            wheelhouse-${{ runner.os }}-

      - name: Upload wheelhouse artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: wheelhouse-artifact
          path: wheelhouse

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push ML stage (using wheelhouse)
        run: |
          set -o pipefail
          docker buildx build \
            --platform linux/amd64,linux/arm64 \
            --file Dockerfile \
            --target ml \
            --build-arg WHEEL_DIR=wheelhouse \
            --tag ghcr.io/${{ github.repository_owner }}/dark8-ml:latest \
            --tag ghcr.io/${{ github.repository_owner }}/dark8-ml:${{ github.sha }} \
            --push . 2>&1 | tee phase4_ml_build_log.txt

      - name: Upload ML build log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ml-build-log
          path: |
            phase4_ml_build_log.txt

